
# TCP/IP 协议20问

## 1/什么是TCP网络分层
![alt text](cf79eb64b5ae7e4f430e0e6b0e05043.png)
一共分为5层：应用层 》》 传输层 》》 网络互连层 》》 网络访问层 》》 物理层
比如说从客户端发送报文，那么必定会经过五层

* （0）由客户端Client发送HTTP请求
* （1）在应用层：从client发送请求，第一层根据HTTP协议组装数据包，以GET方式，携带了GET/HTTP/1.1头进行请求，
* 2）在传输层，增加TCP头部，包含端口号序列号等 TCP头/GET/HTTP/1.1
* 3）在网络互连层，增加IP头部，包含源IP地址等，IP头/TCP头/GET/HTTP/1.1
* 4）在网络访问层，增加以太网头部，包含MAC地址等，以太网头/IP头/TCP头/GET/HTTP/1.1
* 5）来到物理层，到服务端
* 6）继续走到网络访问层，以太网头/IP头/TCP头/GET/HTTP/1.1，根据MAC地址，判断包是不是发给此服务端的，继续走
* 7）来到网络互联层，由IP报文解析，传送数据包，确定路由，IP头/TCP头/GET/HTTP/1.1
* 8）走到下一层，传输层，根据TCP报文解析，/TCP头/GET/HTTP/1.1
* 9）走到应用层，进行HTTP报文解析，保留GET/HTTP/1.1
* 10）来到服务端，接受HTTP数据包
* 
**这种网络分层架构的好处：**

* 应用层：应用程序之间如何互相传递报文，比如HTTP协议
* 传输层：传输层的作用为两台主机之间的“应用进程”提供端到端的逻辑通信，比如TCP协议
* 网络互联层：网络互连层提供了主机到主机的通信，将传输层产生的数据包封装成分组数据包发送到目标主机，并提供路由选择的能力；IP协议是网络层的主要协议，TCP和UDP都是用IP协议作为网络层协议；这一层的主要作用是给包加上源地址和目标地址，将数据包传送到目标地址
* 网络访问层：网络访问层也可以叫做网络接口层，以太网、wifi、蓝牙工作在这一层，网络访问层提供了主机连接到物理网络需要的硬件和相关的协议
* 好处：
  * 各层独立：限制了依赖关系的范围，各层之间使用标准化的接口，各层不需要知道上下层是如何工作的，增加或修改一个应用层协议不会影响传输层的协议
  * 灵活性更好：比如路由器不需要应用层和传输层，分层以后路由器就可以只用加载更少的几个协议层，
  * 易于测试和维护：提高了可测试性，可以独立的测试特定层，某一层有了更好的实现可以整体替换掉
  * 能促进标准化：每一层职责清楚，方便进行标准化

---

## 2/TCP的三次握手中为什么是三次？为什么不是两次、四次？
1、三次握手讲解：
* 第一次：client向服务器发送一个SYN（同步）包，表面客户端需要与服务器建立连接，并在包中指定了自己的初始序列号Seq=x；此刻客户端进入SYN_SENT状态
* 第二次：服务端接收到客户端的SYN包后，会向客户端发送一个SYN+ACK包，其中ACK是对客户端SYN的确认，确定号为Ack=x+1；同时服务器也会指定自己的初始序列号为Seq=y；此刻服务器进入SYN_RCVD状态
* 第三次：客户端接收到服务端的SYN+ACK包后，会向服务器发送一个ACK包，确认包号为ACK=y+1；序列号为Seq=x+1；服务器收到这个ACK包后，连接建立成功，双方进入ESTABLISHED状态；
  
2、为什么不是两次
* 无法确认客户端接收能力：两次握手，服务器无法确认客户端是否接收到正确的SYN+ACK包；比如客户端的SYN包丢失，服务器发送的SYN+ACK包到了客户端，客户端会认为这是一个新的请求而发送RST包拒绝，而服务器认为连接已经建立，导致后续传输出现问题
* 无法可靠建立连接：两次握手不能确认双方都确认彼此的接收和发送能力，可能出现数据传输不稳定的情况，无法保证TCP连接的可靠性

3、为什么不是四次
* 三次已经完成确认：多此一举
* 效率问题：网络开销和时间延迟

**问法**
* 1、原理角度
  * 详细解释一下 TCP 三次握手的过程，以及每一次握手的作用是什么？
    * 第一次握手：client发送SYN包，告知server自己需要建立连接和初始序号，
    * 第二次握手：server发送SYN+ACK包，确认client请求和告知自己的序列号
    * 第三次握手：client发送ACK包，让server知道了client已经收到server的请求，双方确认可以正常收发数据
  * 在 TCP 三次握手过程中，各个阶段的数据包都包含哪些主要字段，这些字段是如何变化的？
    * SYN/ACK/Seq/Ack等字段
    * 第一次：SYN=1,Seq=x，
    * 第二次：SYN=1,ACK=1,Ack=x+1，Seq=y
    * 第三次：ACK=1,Ack=y+1，Seq=y+1
  * TCP 三次握手的过程中，如果第二次握手丢失了，会发生什么情况？
    * client会无法接收到服务器确认而重发SYN包，服务端未接收到client的SYN也会重发SYN+ACK，直到连接建立或超时放弃

* 2、与其它协议对比
  * TCP 三次握手和 UDP 的连接方式有什么本质区别？为什么 UDP 不需要类似的握手过程？
    * TCP是面向连接、可靠的传输协议，需要三次握手进行确认连接保证数据的可靠传输，UDP是无连接的，不保证数据可靠到达，无需握手，适用于对实时性要求高但不要求绝对可靠的场景，如视频直播
  * HTTP 基于 TCP 协议，它在建立连接时是如何利用 TCP 三次握手的
    * HTTP 请求前先通过 TCP 三次握手建立连接，握手成功后 HTTP 在连接上进行数据请求和传输。
* 3、实际应用和优化角度
  * 在高并发场景下，TCP 三次握手可能会带来哪些性能问题？如何优化？
    * 连接延迟、资源消耗；可采用：连接池、优化TCP参数增加缓存，调整超时时间
  * 请举例说明在实际的网络应用中，TCP 三次握手是如何保证数据传输的可靠性的？
    * 三次握手确认client和server准保好传输数据，后续传输、重传等机制保证数据准确到达
  * 在网络环境不稳定的情况下，TCP 三次握手可能会遇到哪些挑战？如何应对这些挑战？
    * 丢包、延迟、资源占用；超时重传、快速重传、拥塞机制

* 4、拓展角度
  * 除了三次握手，TCP 还有哪些重要的机制来保证网络通信的可靠性和效率？
    * 确认应答、超时重传、滑动窗口、拥塞机制
  * 如果让你设计一个类似 TCP 的传输协议，你会考虑保留三次握手这个机制吗？为什么
    * 会；简单高效确认双方确认连接状态和收发能力，为后续可靠连接传输奠定基础，保证连接准确性和高效性的经典设计

## 3/TCP的四次挥手为什么是四次？为什么不能是三次？
四次挥手是为了确保连接双方都可以完成数据传输并且可靠地关闭连接，不能用三次握手取代是以为：
 1、四次挥手的必要性：
  1）TCP连接的半关闭特性：TCP连接是全双工的，这意味着数据可以在两个方向上独立的流动；在关闭连接时候，需要分别处理每个方向上的数据传输和连接关闭，四次挥手就是为了实现这种半关闭的特性，允许乙方先停止发送数据，而另外一方任然继续接收和处理已经发送但未处理完的数据
  2）确保数据的完整性：在挥手过程中，主动关闭方发送FIN包表示它已经没有数据要发送了，但接收方可能还有些数据需要继续发送接收方在收到FIN包后，先回复ACK确认收到了FIN包，这是因为接收方还需要一定的时间来处理和发送剩余的数据，当接收方的数据发送完毕后，在发送FIN包给主动关闭方，主动关闭方收到后发送ACK，这样子确定了双方的数据都能完整的传输和处理

  2、不能用三次挥手的原因：
  1）无法保证数据传输完成：如果采用三次回收，假设主动关闭方发送FIN包后，被动关闭方直接发送FIN+ACK合并的包给主动发，然后主动发回复ACK完成握手；那么这样子可能出现问题，因为被动关闭方在发送ACK和FIN包后，可能还有数据没有传输完成，而主动关闭方收到FIN+ACK后就默认数据已经传输完成，会导致丢数据

  3、四次挥手的完整过程：
  1）第一次挥手：主动关闭方发送一个FIN包，用来关闭主动发收到被动关闭方的数据传送，而此时主动发进入了FIN_WAIT_1状态
  2）第二次挥手：被动关闭方收到FIN包后，发送个ACK给主动关闭方，确认序号为 +1；此时被动关闭方进入CLOSE_AWAIT 状态，而主动关闭方进入FIN_WAIT_2状态
  3）第三次挥手：被动关闭方发送一个FIN，用来关闭被动方到主动关闭方的数据传送，此时被动关闭方进入LAST_ACK状态
  4）第四次挥手：主动关闭方收到了FIN包后，发送一个ACK包给被动关闭方，确认序号为 +1；此时主动个比方进入TIME_WAIT状态，而被动关闭方直接关闭连接，进入CLOSED状态；主动关闭方等待2MSL(最长报文段寿命)后进入CLOSED状态
 
  
## 4/为什么 SYNFIN 不包含数据却要消耗一个序列号
在TCP协议中，SYN和FIN包不包含数据但仍要消耗一个序列号：
1、实现可靠的连接建立与关闭
1）连接建立SYN消耗序列号：SYN标志用于发起TCP连接请求；消耗一个序列号可以让通信双方在连接初始阶段就对序列号达成一致，为后续的数据传输建立一个可靠的起始点；接收方根据这个序列号，能够发送方知道它的连接请求已经被正确接收；双方可以基于这个序列号来对后续传输的数据包进行编号和确认，确保数据传输的有序性和准确性
2）连姐关闭时候FIN消耗序列号：FIN标志用于表达发送方已经完成书v就发送，希望连接光比；消耗一个序列号可以使关闭 连接的国产更加可靠；发送方发送待遇FIN的数据包并且使用一个序列号；接收方对该序列号进行确认；这样子可以保证双方都明确连接关闭的操作已经背对方知晓，避免出现连接关闭国产的数据丢失火状态不一致的问题

2、遵循TCP协议的状态机和滑动窗口机制
1）复合状态机逻辑：TCP协议有一套复杂的状态机来管理连接的各个阶段；SYN和FIN包的序列号消耗是状态机正常运转的一部分；例如，在连接建立时，发送SYN包后，发送方进入SYN_SENT状态，等待接收方的SYN+ACK；消耗序列号使得状态的转变和序列号的交互紧密相关，确保协议状态的准确切换和连接的正确管理
2）适配滑动窗口机制：滑动窗口用于控制数据流量和实现可靠传输；序列号是滑动窗口机制的关键元素。即使是SYN和FIN这样的康之宝。消耗序列号也有助于在连接建立和关闭阶段与滑动窗口机制进行协调；比如，在连接建立时，通过SYN包的序列号可以确定初始的窗口大小和数据传输的起始位置，为后续滑动窗口的数据传输做好准备

3、便于差错检测与恢复
1）检测数据丢失火重复：序列号在TCP的差错检测中骑着主要左右；SYN和FIN包消耗序列号可以让接收方更加容易检测到是否有数据包丢失或重复，例如，如果接收方没有收到某个SYN或者FIN包对应的确认ACK，发送方可以根据序列号出发该包，以确保连接建立或关闭国产的顺利进行
2）协助回复连接状态：在网络出现故障或异常。序列号有助于TCP进行连接状态的回复；如果在连接建立或关闭过程中出现问题，通过记录和检查序列号，双方可以确定当前的连接进度，进而采取相应的措施来回复连接，保证通信的可靠性


## 5/什么是半连接队列？什么是SYN Flood攻击？
1、半连接队列
1）定义：半连接队列也叫SYN队列，是TCP协议在处理连接过程中用于临时存储尚未完全建立连接的请求的一种数据结构；在TCP三次握手过程中，当服务器收到客户端发送的SYN包后，会讲该连接的请求放入半连接队列，并向客户端发送SYN+ACK包，此时连接处于半连接状态，即使客户端发起了连接请求，但是服务器还未收到客户端对SYN+ACK的确认包
2）作用：
* 缓冲连接请求：它起到了缓冲的作用，允许服务器在处理连接请求时，有一定的缓冲空间，避免因为同时处理过多的连接请求而导致系统崩溃或性能下降
* 维持连接状态：在半连接队列中的连接请求会保持相应的状态嘻嘻，知道收到客户端的ACK包或者连接请求超时

2、SYN Flood攻击
1）定义：SYN Flood攻击是一种常见的DDos（分布式拒绝攻击服务）攻击方式，它利用了TCP协议三次握手的特性来发起攻击，攻击者通过伪造大量源IP地址，向目标服务器发送海量的SYN包，请求建立TCP连接，但是不完成三次握手的后续步骤，既不回复服务器发送的SYN+ACK包

2）原理：
* 耗尽资源：由于服务器会为每个接收到的 SYN 包分配一定的资源，如在半连接队列中为其分配空间，并等待客户端的 ACK 包。当大量伪造的 SYN 包涌入时，半连接队列会被迅速填满，导致服务器无法处理正常的连接请求。
* 造成拒绝服务：随着半连接队列的满溢，服务器可能会开始丢弃新的连接请求，或者因为忙于处理这些虚假的连接请求而导致性能急剧下降，最终无法为合法用户提供正常的服务，从而达到拒绝服务的攻击目的。
3）危害：
* 业务中断：使目标服务器无法正常提供服务，导致网站无法访问、应用程序无法连接等问题，给企业和用户带来严重的损失。
* 数据丢失或损坏：在服务器资源耗尽的情况下，可能会导致正在处理的数据丢失或损坏，影响业务的正常运行和数据的完整性。
* 声誉受损：服务中断可能会影响企业的声誉，导致用户信任度下降，对企业的长期发展造成负面影响。
## 6/说说TCP快速打开(TFO)的原理！
## 7/TCP报文中的时间戳有什么作用？
## 8/TCP 的超时重传时间是如何计算的？
## 9/能不能说一说 TCP 的流量控制？
## 10/如何理解 TCP 的keep-alive的原理？
## 11/聊一聊TCP中的端口号
## 12/TCP场景问题1
## 13/TCP场景问题2
## 14/TCP场景问题3
## 15/讲一讲telnet的用法
## 16/讲一讲netstat的用法
## 17/讲一讲tcpdump的用法
## 18/讲一讲wireshark的用法
## 19/TCP和UDP的区别
## 20/如果要你来设计一个QQ，在网络协议上你会考虑什么
1、登录采用TCP、HTTP，实时聊天UDP，内网P2P
2、登录过程，客户端client采用TCP协议向服务器server发送信息，HTTP协议下载信息，登录之后，会有一个TCP连接来保持在线状态
3、同好友进行信息传输，客户端client采用UDP将进行双向传输，但是还是得经过nginx服务器反向代理转发，为了确保传输消息的可靠，得采用上层协议保证可靠传输，如果消息发送失败，客户端会提示传输失败，进行重新传输
4、内网传输：P2P，无需服务器中转

